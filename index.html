<html>
  <head>
       <link href="https://vjs.zencdn.net/4.12/video-js.css" rel="stylesheet">
      <script src="https://vjs.zencdn.net/4.12/video.js"></script>
      <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
      <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
      <script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js" crossorigin="anonymous"></script>
      <style type="text/css">
        .vjs-default-skin .vjs-play-progress,
        .vjs-default-skin .vjs-volume-level { background-color: #ff0000 }
        .vjs-default-skin .vjs-control-bar,
        .vjs-default-skin .vjs-big-play-button { background: rgba(0,0,0,0.7) }
        .vjs-default-skin .vjs-slider { background: rgba(0,0,0,0.2333333333333333) }
        .vjs-default-skin .vjs-control-bar { font-size: 200% }
        
        /* Chat styles */
        .video-container {
          display: flex;
          gap: 20px;
          max-width: 1600px;
          margin: 0 auto;
        }
        
        .chat-container {
          width: 300px;
          background: rgba(0,0,0,0.7);
          border-radius: 8px;
          display: flex;
          flex-direction: column;
          height: 720px;
        }
        
        .chat-messages {
          flex-grow: 1;
          overflow-y: auto;
          padding: 10px;
          color: white;
        }
        
        .chat-input {
          display: flex;
          padding: 10px;
          background: rgba(0,0,0,0.8);
          border-radius: 0 0 8px 8px;
        }
        
        .chat-input input {
          flex-grow: 1;
          padding: 8px;
          border: none;
          border-radius: 4px;
          margin-right: 10px;
        }
        
        .chat-input button {
          padding: 8px 16px;
          background: #ff0000;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
        }
        
        .message {
          margin-bottom: 10px;
          padding: 8px;
          background: rgba(255,255,255,0.1);
          border-radius: 4px;
        }
        
        .message .sender {
          font-weight: bold;
          color: #ff0000;
          margin-right: 5px;
        }
        
        .message .time {
          font-size: 0.8em;
          color: #ccc;
        }

        .typing-indicator {
          padding: 8px;
          color: #ccc;
          font-style: italic;
          font-size: 0.9em;
        }

        .emoji-picker {
          position: absolute;
          bottom: 50px;
          right: 10px;
          background: rgba(0,0,0,0.9);
          padding: 10px;
          border-radius: 8px;
          display: none;
          max-height: 200px;
          overflow-y: auto;
        }

        .emoji-picker.show {
          display: block;
        }

        .emoji-button {
          background: none;
          border: none;
          color: white;
          font-size: 1.2em;
          cursor: pointer;
          padding: 5px;
        }

        .emoji-grid {
          display: grid;
          grid-template-columns: repeat(8, 1fr);
          gap: 5px;
        }

        .emoji-item {
          cursor: pointer;
          padding: 5px;
          text-align: center;
          font-size: 1.2em;
        }

        .emoji-item:hover {
          background: rgba(255,255,255,0.1);
          border-radius: 4px;
        }
      </style>
  </head>
<body> 
    <div class="video-container">
      <div>
        <form>
          Type the Link: <input type="text" name="videolink" id="vlink">
          <input type="button" value="Play Video" onclick="changelink();">
        </form>
        <br/>
        <video id='my-video' class='video-js vjs-default-skin vjs-big-play-centered' controls preload='auto' width="1280" height="720" data-setup='{}'>
        <source id='cvid' src='https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4' type='video/mp4'>
        <p class='vjs-no-js'>
          To view this video please enable JavaScript, and consider upgrading to a web browser that
          <a href='https://videojs.com/html5-video-support/' target='_blank'>supports HTML5 video</a>
        </p>
      </video>
      </div>
      
      <div class="chat-container">
        <div class="chat-messages" id="chatMessages"></div>
        <div class="typing-indicator" id="typingIndicator"></div>
        <div class="chat-input">
          <input type="text" id="chatInput" placeholder="Type a message...">
          <button class="emoji-button" onclick="toggleEmojiPicker()">😊</button>
          <button onclick="sendMessage()">Send</button>
        </div>
        <div class="emoji-picker" id="emojiPicker">
          <div class="emoji-grid" id="emojiGrid"></div>
        </div>
      </div>
    </div>

  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDH1puytL8OHsTQS7lZD_Ljg80pRi1W49c",
      authDomain: "movie-dates-594ec.firebaseapp.com",
      databaseURL: "https://movie-dates-594ec-default-rtdb.firebaseio.com",
      projectId: "movie-dates-594ec",
      storageBucket: "movie-dates-594ec.firebasestorage.app",
      messagingSenderId: "64182703538",
      appId: "1:64182703538:web:c72b6ef5f8b898e6dd80ab",
      measurementId: "G-Z951WDGKTL"
    };
    
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    // Add connection state logging
    database.ref('.info/connected').on('value', (snap) => {
      console.log('Firebase connected:', snap.val());
    });

    var Cvid = document.getElementById('cvid');
    var player = videojs('my-video');
    var Vlink = document.getElementById('vlink');
    var chatInput = document.getElementById('chatInput');
    var chatMessages = document.getElementById('chatMessages');
    var typingIndicator = document.getElementById('typingIndicator');
    var emojiPicker = document.getElementById('emojiPicker');
    var emojiGrid = document.getElementById('emojiGrid');
    
    // Generate a random user ID for this session
    const userId = 'user_' + Math.random().toString(36).substr(2, 9);
    
    // Reference to the video state in Firebase
    const videoStateRef = database.ref('videoState');
    // Reference to the chat messages
    const chatRef = database.ref('chat');
    // Reference to typing status
    const typingRef = database.ref('typing');
    
    // Common emojis to display
    const commonEmojis = [
      '😊', '😂', '❤️', '👍', '👋', '🎉', '🔥', '💯',
      '😍', '😎', '🤔', '😢', '😡', '🤣', '🙏', '👏',
      '🎮', '🎵', '🎬', '📚', '🎨', '⚽', '🎸', '🎯'
    ];

    // Initialize emoji picker
    commonEmojis.forEach(emoji => {
      const emojiItem = document.createElement('div');
      emojiItem.className = 'emoji-item';
      emojiItem.textContent = emoji;
      emojiItem.onclick = () => {
        chatInput.value += emoji;
        chatInput.focus();
      };
      emojiGrid.appendChild(emojiItem);
    });

    function toggleEmojiPicker() {
      emojiPicker.classList.toggle('show');
    }

    // Close emoji picker when clicking outside
    document.addEventListener('click', (e) => {
      if (!emojiPicker.contains(e.target) && e.target.className !== 'emoji-button') {
        emojiPicker.classList.remove('show');
      }
    });

    // Typing indicator logic
    let typingTimeout;
    chatInput.addEventListener('input', () => {
      // Set user as typing
      typingRef.child(userId).set({
        typing: true,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });

      // Clear previous timeout
      clearTimeout(typingTimeout);
      
      // Set timeout to mark user as not typing
      typingTimeout = setTimeout(() => {
        typingRef.child(userId).set({
          typing: false,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
      }, 1500);
    });

    // Listen for typing status changes
    typingRef.on('value', (snapshot) => {
      const typingData = snapshot.val();
      if (typingData) {
        const typingUsers = Object.entries(typingData)
          .filter(([id, data]) => id !== userId && data.typing)
          .map(([id]) => id.substring(0, 8) + '...');
        
        if (typingUsers.length > 0) {
          typingIndicator.textContent = `${typingUsers.join(', ')} ${typingUsers.length === 1 ? 'is' : 'are'} typing...`;
          typingIndicator.style.display = 'block';
        } else {
          typingIndicator.style.display = 'none';
        }
      }
    });
    
    // Listen for new chat messages
    chatRef.on('child_added', (snapshot) => {
      const message = snapshot.val();
      console.log('New message received:', message);
      addMessageToChat(message);
    });
    
    function addMessageToChat(message) {
      console.log('Adding message to chat:', message);
      const messageElement = document.createElement('div');
      messageElement.className = 'message';
      
      // Parse emojis in the message
      const parsedText = twemoji.parse(message.text, {
        folder: 'svg',
        ext: '.svg'
      });
      
      messageElement.innerHTML = `
        <span class="sender">${message.sender}:</span>
        <span class="text">${parsedText}</span>
        <span class="time">${new Date(message.timestamp).toLocaleTimeString()}</span>
      `;
      chatMessages.appendChild(messageElement);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function sendMessage() {
      const text = chatInput.value.trim();
      console.log('Sending message:', text);
      if (text) {
        chatRef.push({
          text,
          sender: userId,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
          console.log('Message sent successfully');
        }).catch((error) => {
          console.error('Error sending message:', error);
        });
        chatInput.value = '';
        
        // Mark user as not typing
        typingRef.child(userId).set({
          typing: false,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
      }
    }
    
    // Allow sending message with Enter key
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
    
    // Listen for changes in video state and URL
    videoStateRef.on('value', (snapshot) => {
      const data = snapshot.val();
      console.log('Received sync data:', data);
      if (data) {
        // Sync URL if different
        if (data.currentUrl && data.currentUrl !== Vlink.value) {
          console.log('Syncing URL to:', data.currentUrl);
          Vlink.value = data.currentUrl;
          Cvid.setAttribute('src', data.currentUrl);
          player.src({ type: 'video/mp4', src: data.currentUrl });
          player.load();
        }

        // Only update if the change is from another client
        if (Math.abs(player.currentTime() - data.currentTime) > 1) {
          console.log('Syncing time to:', data.currentTime);
          player.currentTime(data.currentTime);
        }
        
        if (data.isPlaying && player.paused()) {
          console.log('Syncing play state');
          player.play();
        } else if (!data.isPlaying && !player.paused()) {
          console.log('Syncing pause state');
          player.pause();
        }
      }
    });

    // Update Firebase when video state changes
    player.on('play', () => {
      videoStateRef.update({
        isPlaying: true,
        currentTime: player.currentTime(),
        currentUrl: Vlink.value,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
    });

    player.on('pause', () => {
      videoStateRef.update({
        isPlaying: false,
        currentTime: player.currentTime(),
        currentUrl: Vlink.value,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
    });

    player.on('seeked', () => {
      videoStateRef.update({
        currentTime: player.currentTime(),
        currentUrl: Vlink.value,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
    });

    player.on('timeupdate', () => {
      // Only update if the video is playing
      if (!player.paused()) {
        videoStateRef.update({
          currentTime: player.currentTime(),
          currentUrl: Vlink.value,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
      }
    });

    function changelink(){
      const newUrl = Vlink.value;
      Cvid.setAttribute('src', newUrl);
      player.src({ type: 'video/mp4', src: newUrl });
      player.load();
      
      // Update Firebase with new URL
      videoStateRef.update({
        currentUrl: newUrl,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
    }
  </script>
  </body>
</html>